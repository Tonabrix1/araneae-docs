# Scanner Scripts

###### *this functionality is only supported for the default scanning mode that uses grequests, webdriver implementations are planned for the future*

Scanner scripts are scripts that prepare requests to send and return them in a generator object.

To add a scanner script you must simply create a python file containing a function similar to the following:

```py
def endpoints(urls, headers, settings):
    return (grequests.get(url,headers=headers) for url in urls)
```

The `urls` parameter contains the list of urls that the tool is preparing to scan  
The `headers` parameter is a dictionary of headers  
The `settings` parameter is a dictionary of settings for the tool  
The `canaries` parameter is a set of canary strings, which can be used to check for a reflected value in O(1) avg time  

This function will return a generator of prepared grequest objects; it's important to use generators (lazy iteration) here to avoid sending the requests when `endpoints` is called.

# Example

Below is an example of a spider script `verbtamperspider.py`:

```py
import grequests
from tools.utilities import add_script_cli_arg

METHODS = ['delete','post','put', 'patch','options','head']

@add_script_cli_arg('-vt','--verbtamperspider', help='-vt | (Spider) Fuzzes DELETE, POST, PUT, PATCH, OPTIONS, and HEAD methods in each request\n')
def endpoints(urls, headers, settings, canaries):
    return (getattr(grequests,method)(url,headers=headers) for method in METHODS for url in urls)
```


# Parser Scripts

You can also implement parser scripts in the same directory by using the function format:

```py
def parse(resp, settings):
    return set(...)
```

The `resp` parameter is the requests.response object generated by grequests (or a webdriver)

The `settings` parameter is a dictionary of settings for the tool

The function must return a set of the urls it has parsed.  The parser will format them relative to the url after they have been returned, no need to prepend the host to relative urls, for example.

# Example

Below is an example of a parser script from `scourjs.py`.

```py
import re
from tools.utilities import join, add_script_cli_arg, BASE_PATH

with open(join(BASE_PATH, 'resources/jsregex.txt')) as f: regex = f.read().strip('\n')


@add_script_cli_arg("-sjs", "--scourjs", help='-js | (Parser) Parses js files for possible endpoints in quotes\n')
def parse(resp, settings):
    if not resp.url.endswith('js'): return

    outp = set()
    for g in re.findall(regex, resp.text):
        if len(g) > 0: outp.add(g[0])
    return outp
```

# Decorator

The `tools.utilities.add_script_cli_arg` decorator can be used to dynamically add arguments via `argparse.ArgumentParser.add_argument`.

`action='store_true'` will automatically be passed along with the arguments specified, making the flag a bool which defaults to `False`.

This decorator will automatically activate the script when the flag is used.

### NOTE: The name of the argparse argument (`--scourjs` in this case) ***MUST*** be the same as the python file (without the .py extension - `scourjs.py` in this example)
